<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8">
<html lang="en">
	<head>
		<title> VR Patterns </title>
		<script src="https://cdn.babylonjs.com/babylon.js"></script>
		<script src="https://cdn.babylonjs.com/gui/babylon.gui.js"></script>                  <!-- plugin for GUI-->
		<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>    <!-- plugin for loading 3D models-->
		<script src="https://unpkg.com/earcut@2.1.1/dist/earcut.min.js"></script>     
		<script src = "js/navigations.js"></script>    
		<script src = "js/controller.js"></script>            
        <script src = "js/scripts.js"></script>    
		<style>
			canvas 
			{
				width: 100%; height: 100%; background-color: black;
			}
		</style>
    </head>

        <body>
            <canvas class="sceneCanvas" id = "patternCanvas"></canvas>
            <script type = "text/javascript">
                    const canvas = document.getElementById("sceneCanvas");      //get the canvas element
                    const engine = new BABYLON.Engine(canvas, true);            //generates the babylon 3D engine
                    let creatScene = function()
                    {
                        let scene = new BABYLON.Scene(engine);            
                        // camera
                        //let camera = new BABYLON.ArcRotateCamera("Camera", -Math.PI/2, Math.PI / 3, 25, new BABYLON.Vector3(0, 0, 4.5), scene);
                        let camera = new BABYLON.ArcRotateCamera("Camera", -3.85, 0.72, 325.57, new BABYLON.Vector3(0, 0, 0), scene);

                        //camera.setTarget(BABYLON.Vector3.Zero());
                        camera.attachControl(canvas, true);

                        let light = new BABYLON.HemisphericLight("hemiLight", new BABYLON.Vector3(5, 10, 0), scene);
                        let ground;
                        let start = function () {
                            //room scaling and positioning
                            let sky = scene.getNodeByName("sky");
                            if (sky)
                            {			
                                sky.setEnabled(false);
                            }
                            ground = scene.getNodeByName("ground");
                        };
                        
                        let assetsManager = new BABYLON.AssetsManager(scene);

                        assetsManager.onFinish = function (tasks) 
                        {                
                            start();
                        };
                        
                        let myMesh = [];
                        //loadEntitiy definition in js/script.js
                        LoadEntity("scene", "", "./assets/models/", "testScene.glb", assetsManager, myMesh);
                        
                        assetsManager.load();

                        let defaultXRExperience = scene.createDefaultXRExperienceAsync({
                            xrInput: xrHelper.input,
                            floorMeshes: [ground]
                        });

                        if (!defaultXRExperience.baseExperience) {
                            // no xr support
                        } else {
                            // all good, ready to go
                            //useNavigationPatterns(defaultXRExperience, [ground]);
                            
                            let featuresManager = xr.baseExperience.featuresManager; // or any other way to get a features manager
                            featuresManager.enableFeature(WebXRFeatureName.TELEPORTATION, "stable" /* or latest */, {
                                xrInput: xr.input,
                                // add options here
                                floorMeshes: [ground],
                            });

                            // ...
                            // needs a reconfigure - re-enable the feature (will discard the old one and create a new one!)
                            defaultXRExperience.teleportation = featuresManager.enableFeature(WebXRFeatureName.TELEPORTATION, "stable" /* or latest */, {
                                xrInput: defaultXRExperience.input,
                                floorMeshes: [ground],
                                renderingGroupId: 1,
                            });
                            let teleportation = featuresManager.enableFeature(WebXRFeatureName.TELEPORTATION, "stable", 
                            {
                                xrInput: xr.input,
                                floorMeshes: [ground],
                                defaultTargetMeshOptions: 
                                {
                                    teleportationFillColor: "#55FF99",
                                    teleportationBorderColor: "blue",
                                    disableLighting: true
                                },
                            });
                        }   
                        return scene;       
                    }
                    const scene = createScene(); //Call the createScene function

                    // Register a render loop to repeatedly render the scene
                    engine.runRenderLoop(function () {
                    scene.render();
                    });
                    
                    //--------------------------------------------------------------------------------
                    window.addEventListener("resize", function()
                    {
                        engine.resize();                            
                    });
        </script>
	</body>
</html>